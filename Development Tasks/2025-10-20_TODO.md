# Development Tasks - October 20, 2025

## Task List Filtering
**Status**: COMPLETED ✅

**Task**: Task list (job board) should only show tasks whose project is using task-based scheduling.

**Implementation**: Filter out tasks from project-based projects entirely. If a project is using project-based scheduling, its tasks should not be shown as they are not being used. When a project is changed to task-based scheduling, that project's tasks should appear in the list.

**Solution Implemented**:
- Added filter in JobBoardView.swift filteredTasks computed property (lines 580-585)
- Filters out any task whose project has eventType == .project
- Only shows tasks from projects with eventType == .task
- Build succeeded with no errors

**File Modified**: JobBoardView.swift

**Rationale**: Prevents confusion for users seeing a huge list of tasks and not knowing which are in use.

---

## Project Completion Cascade
**Status**: Not Started

**Task**: When a project is marked complete, all of that project's tasks should be marked complete.

**Implementation**:
- Sync task status changes to API
- Show confirmation dialog warning user that all incomplete tasks will be marked complete
- After confirmation, mark all tasks as completed and sync to backend

---

## Task List Sections
**Status**: Not Started

**Task**: Task list (job board) - move completed and cancelled tasks to collapsible sections.

**Implementation**:
- Create collapsible sections identical in formatting and style to project list's archived and closed sections
- Sections should start collapsed by default
- Show count badges: "COMPLETED (5)" and "CANCELLED (2)"
- Match exact styling of project list collapsible sections

---

## Selection Mode for Lists
**Status**: Future Implementation (V2)

**Task**: Task, project, client list (job board) - add 'select' option to quick actions menu.

**Implementation Details** (for future reference):
- Add "Select" option to quick actions menu
- Show checkboxes on cards when in selection mode
- Top bar actions: "Change Status", "Delete Selection", "Deselect All"
- "Change Status" shows all possible statuses (different for tasks vs projects)
- Delete selection requires confirmation dialog with count
- Include "Deselect All" button (no "Select All")

**Note**: Moving to V2_FEATURES_ROADMAP.md for now

---

## Project Details Notes Expansion
**Status**: COMPLETED ✅

**Task**: Project details notes - if there are more lines of text that are collapsed, show that somehow.

**Implementation**:
- Display 3 lines of notes content before collapsing
- If more than 3 lines exist, show "Show more..." text and gradient fade effect
- Both gradient and "Show more" text should be visible when content is collapsed

**Solution Implemented**:
- Modified ExpandableNotesView.swift
- Added LinearGradient overlay that fades from transparent to cardBackgroundDark
- Added "Show more..." button when notes are collapsed
- Button triggers expansion animation
- Build succeeded with no errors

**File Modified**: ExpandableNotesView.swift (lines 130-173)

---

## Job Board Archive Drag Issue
**Status**: In Progress - Debug Logging Added

**Task**: Job board - dragging project to 'archive' does not work.

**Issue**: Drag gesture and UI responsiveness works visually, but functionality does not work.

**Investigation**: Added debug logging to `changeProjectStatus()` in JobBoardDashboard.swift (lines 356-371) to track:
- When status change is triggered
- Old and new status values
- Save success/failure

**Next Step**: Run app and check console logs when dragging to archive.

---

## Job Board Padding
**Status**: COMPLETED ✅

**Task**: Job board - need to add horizontal padding.

**Solution Implemented**:
- Added `.padding(.bottom, 8)` to search bar in JobBoardView.swift (line 93)
- Provides visual spacing below search bar for better layout

**File Modified**: JobBoardView.swift

---

## Project Creation with Photos
**Status**: COMPLETED ✅

**Task**: Project creation - creating project with photos does not work.

**Issue**: Photos are not being linked to the project. Uncertain if they are being uploaded to AWS.

**Solution Implemented**:
- Added photo upload logic in ProjectFormSheet.swift after project is linked to company
- Uses ImageSyncManager.saveImages() to upload photos to S3 and link to project
- Photos are now properly uploaded and linked when creating projects
- Build succeeded with no errors

**File Modified**: ProjectFormSheet.swift (lines 798-802)

---

## Photo Delete Button Styling (Project Creation)
**Status**: COMPLETED ✅

**Task**: In project creation (extended view), the X button on photos that have been added is being cut off.

**Issues**:
- X icon is positioned at the top but photo element is cutting off part of the icon
- X icon styling does not match OPS UI design

**Solution Implemented**:
- Changed from ZStack to .overlay(alignment: .topTrailing) to prevent clipping
- Updated icon size to 24pt with proper background circle
- Added 6pt padding for proper positioning
- Delete button now properly overlays on image without being cut off
- Build succeeded with no errors

**File Modified**: ProjectFormSheet.swift (lines 605-619)

---

## Delete Project Button
**Status**: COMPLETED ✅

**Task**: Project details - add a delete project button.

**Implementation**:
- Add separate button at the bottom of ProjectDetailsView
- Available to admin/office crew only
- Show simple confirmation dialog
- Handle project deletion and sync to API

**Solution Implemented**:
- Added delete button with OPSStyle.Colors.errorStatus styling
- Button shows confirmation alert before deletion
- Deletes project from API and local database
- Only visible to admin/office crew via canEditProjectSettings()
- Build succeeded with no errors

**Permissions**: Admin and office crew only

**File Modified**: ProjectDetailsView.swift (lines 1221-1331)

---

## Field Crew Add Photos Button
**Status**: COMPLETED ✅

**Task**: Field crew cannot see the add photos button in project details view.

**Solution Implemented**:
- Removed canEditProjectSettings() check from addPhotosButton
- Add photos button now visible to all users including field crew
- Field crew can add photos even though they can't modify other project settings
- Build succeeded with no errors

**File Modified**: ProjectDetailsView.swift

---

## Remove Autocorrect
**Status**: COMPLETED - IMPORTANT ✅

**Task**: Remove predictive text/autocorrect from ALL input fields that are not addresses.

**Implementation**:
- Disable autocorrect for:
  - Project names
  - Client names
  - Task names
  - Notes fields
  - Phone numbers
  - Email addresses
  - All other text inputs except address fields

**Keep autocapitalization on**:
  - Project names
  - Client names
  - Task names
  - Other proper noun fields

**Solution Implemented**:
- Added `.autocorrectionDisabled(true)` to 24 TextField instances across 15 files
- Preserved `.textInputAutocapitalization(.words)` for proper noun fields
- Excluded AddressSearchField.swift and AddressAutocompleteField.swift as required
- Updated legacy API calls for consistency
- Build succeeded with no errors

**Files Modified** (15 total):
- ProjectFormSheet.swift, TaskFormSheet.swift, ClientFormSheet.swift
- ProjectDetailsView.swift, TaskTypeFormSheet.swift
- CalendarFilterView.swift, ClientSearchField.swift
- ClientEditSheet.swift, SubClientEditSheet.swift
- And 6 more files

**Code**: Set `.autocorrectionDisabled(true)` and keep `.textInputAutocapitalization(.words)` where appropriate

---

## Project-Based Calendar Event Title
**Status**: COMPLETED ✅

**Task**: Project-based calendar event creation - change the title of the calendar event to the client's name.

**Current**: Calendar event title is set to project title
**New**: Calendar event title should be set to client's name

**Solution Implemented**:
- Updated calendar event title to use project.clientName instead of project.title
- Changed in SyncManager.swift (lines 3327, 3342)
- Changed in ProjectFormSheet.swift (line 896)
- Build succeeded with no errors

**Files Modified**: SyncManager.swift, ProjectFormSheet.swift

---

## Task Creation - Deactivate Project Calendar Event
**Status**: COMPLETED ✅

**Task**: When tasks are created in-app, change the project's project-based calendar event 'active' to false.

**Rationale**: When a project is converted from project-based to task-based scheduling, we need to hide the project's calendar event (set active = false) because we should only show either task calendar events OR project calendar event, not both.

**Solution Implemented**:
- Already implemented in TaskFormSheet.swift (lines 546-551)
- When task is created, project's eventType is updated to .task
- Project's primaryCalendarEvent.active is set to false
- Changes synced to Bubble API
- Build succeeded with no errors

**File**: TaskFormSheet.swift

---

## Calendar Event Creation Bug
**Status**: COMPLETED & TESTED - CRITICAL ✅✅

**Task**: Calendar event creation - when adding new calendar event to company.calendarEventsList, we are SETTING the list to the new event instead of ADDING to it.

**Issue**: Each time a new calendar event is created, the list is being overwritten with only the new calendar event as the single entry.

**Root Cause Found**: CompanyDTO was using incorrect Bubble field name mapping. CodingKey was set to "Calendar EventsList" (with space) but the actual Bubble field name is "Calendar.EventsList" (with dot notation). This caused the field to never be decoded, so `calendarEventsList` was always nil, making our code think there were no existing events and overwriting the list instead of appending.

**Solution Implemented**:
- Created universal `createAndLinkCalendarEvent()` method in CalendarEventEndpoints.swift
- This method automatically creates the calendar event AND links it to the company's calendar events list
- Refactored all 6 calendar event creation locations to use the new universal method:
  1. ProjectFormSheet.swift (line 896)
  2. TaskListView.swift (line 490)
  3. ProjectDetailsView.swift (line 456)
  4. SyncManager.swift - project creation (line 3253)
  5. SyncManager.swift - task sync (line 1008)
  6. TaskFormSheet.swift (line 562)
- Fixed bug where SyncManager task sync was not linking events to company at all
- **Fixed CompanyDTO CodingKey**: Changed "Calendar EventsList" to "Calendar.EventsList" (line 131)
- Build succeeded with no errors

**Files Modified**:
- CalendarEventEndpoints.swift: Added createAndLinkCalendarEvent() universal method
- ProjectFormSheet.swift: Updated to use universal method
- TaskListView.swift: Updated to use universal method
- ProjectDetailsView.swift: Updated to use universal method
- SyncManager.swift: Updated both project and task creation to use universal method
- TaskFormSheet.swift: Updated to use universal method
- **CompanyDTO.swift: Fixed CodingKey to use correct Bubble field name**

---

## Task List Team Member Avatars
**Status**: COMPLETED - Already Implemented ✅

**Task**: Task list in project details view - assigned team member avatars are not being displayed on the card.

**Verification**: Feature already implemented in TaskListView.swift (lines 244-270)
- Shows avatars for up to 3 team members
- Displays "+X" badge when more than 3 team members are assigned
- Uses proper avatar styling and layout

**File**: TaskListView.swift

---

## Task Deletion Dismissal Handling
**Status**: Not Started

**Task**: Deleting task from task list quick actions in project details view - after delete completes, the project details view and confirmation dialogue close abruptly.

**Issue**: Functionality works, but dismissal is not graceful.

**Implementation**:
- Handle dismissal gracefully
- Only dismiss confirmation dialog
- ProjectDetailsView should remain open
- Possibly show a toast/banner confirming deletion

---

## Job Board Search Bar Padding
**Status**: Not Started

**Task**: Job board view search bar (visible on client, project and task tabs) - add slight padding below.

**Implementation**: Add padding below search bar for better visual spacing

---

## Task Color Assignment Investigation
**Status**: Not Started - Investigation Only

**Task**: Explore how task color is being assigned when tasks are created. Some tasks do not have correct color when viewed in Bubble.

**Action**: Investigation only - do not write code yet. Document findings.

**Check**:
- Where task color is set during creation
- How TaskType color is applied
- If color is being synced to Bubble correctly
- If there's a default color fallback

---

## No Address Display
**Status**: COMPLETED ✅

**Task**: Project cards, task cards - if no address is available, display "NO ADDRESS". Addresses should be trimmed to show only street number, street, and city (no postal code or country).

**Solution Implemented**:
- Added conditional check to display "NO ADDRESS" when address is empty
- Applied `.formatAsSimpleAddress()` to trim addresses to street and city only
- Updated UniversalJobBoardCard.swift for both project and task cards (lines 771, 773, 811, 813)
- "NO ADDRESS" text is displayed in all capitals as required

**File Modified**: UniversalJobBoardCard.swift

---

## Duplicate Calendar Events on Date Change
**Status**: COMPLETED - HIGH PRIORITY ✅

**Task**: Each time project dates are changed, a new calendar event is created instead of updating the existing one.

**Issue**: Discovered during testing - changing project dates creates duplicate calendar events.

**Root Cause**: The createCalendarEventForProject() function created a calendar event but never linked it back to project.primaryCalendarEvent, so the next date change thought no event existed and created a duplicate.

**Solution Implemented**:
- Added `project.primaryCalendarEvent = calendarEvent` after creating calendar event
- Now when dates change, the code finds the existing calendar event and updates it
- No duplicate events created
- Build succeeded with no errors

**File Modified**: ProjectDetailsView.swift (line 464)

**Implementation**:
- Checks if project already has a calendar event before creating a new one
- If calendar event exists, updates its dates instead of creating a new event
- Only creates new calendar event if one doesn't exist

---

## Offline Error Handling - Project Creation
**Status**: COMPLETED - HIGH PRIORITY ✅

**Task**: Project creation when offline shows "API Network error 7" instead of user-friendly message.

**Current**: Displays technical error "API Network error 7"
**New**: Display "WEAK/NO CONNECTION, QUEUING FOR LATER SYNC. SAVED LOCALLY" message

**Solution Implemented**:
- Refactored createNewProject() in ProjectFormSheet.swift
- Projects now created locally first with needsSync = true
- Network sync wrapped in 5-second timeout using Task.timeout extension
- If network fails/times out, shows user-friendly message and saves project offline
- Project will sync automatically when connection restored
- Build succeeded with no errors

**File Modified**: ProjectFormSheet.swift (lines 725-822)

**Implementation**:
- Network timeout set to max 5 seconds before showing weak/no connection
- Shows user-friendly message instead of technical error
- 2-second delay before dismissing sheet
- Project saved locally and will sync when connection restored

---

## Offline Task Creation Failure
**Status**: COMPLETED - CRITICAL ✅

**Task**: Tasks are not created at all when offline.

**Issue**: Discovered during testing - task creation fails completely when offline instead of saving locally.

**Solution Implemented**:
- Refactored saveTask() in TaskFormSheet.swift
- Tasks now created locally first with needsSync = true
- Network sync wrapped in 5-second timeout using Task.timeout extension
- If network fails/times out, shows user-friendly message and saves task offline
- Task will sync automatically when connection restored
- Added Task.timeout extension for async timeout handling
- Build succeeded with no errors

**Files Modified**:
- TaskFormSheet.swift (lines 453-657) - Refactored saveTask()
- TaskFormSheet.swift (lines 640-657) - Added Task.timeout extension

**Implementation**:
- Tasks created locally when offline
- Queued for sync when connection restored
- Shows user-friendly message: "WEAK/NO CONNECTION, QUEUING FOR LATER SYNC. SAVED LOCALLY"
- Uses 5 second network timeout max

---

## Summary

### COMPLETED IN THIS SESSION: 5 Critical/High Priority Tasks ✅
1. **Calendar Event Creation Bug** - Fixed list overwriting issue (CompanyDTO field name)
2. **Duplicate Calendar Events on Date Change** - Fixed missing project link
3. **Offline Task Creation Failure** - Implemented offline-first with timeout
4. **Offline Error Handling - Project Creation** - Implemented offline-first with timeout
5. **Remove Autocorrect** - Disabled on 24 TextFields across 15 files
6. **Task List Filtering** - Filter out project-based scheduling tasks

### REMAINING TASKS BY PRIORITY:
- **Critical**: 1 task (Task Creation Calendar Event Deactivation)
- **High Priority**: 9 tasks (Project completion cascade, Photo linking, etc.)
- **Medium Priority**: 6 tasks (UI polish, padding, styling)
- **Investigation**: 1 task (Task color assignment)
- **Future**: 1 task (Selection mode - moved to V2)

**Total Active Tasks**: 17 remaining
**Future Tasks**: 1
**Completed Tasks**: 6 (including calendar event bug from previous session)
